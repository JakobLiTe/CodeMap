
<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>REDSHIFT: CRYPT</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap');

    body{
        background-color: #000;
    }

#terminal {
  background-color: #000;     
  color: #00ff00;             
  font-family: "JetBrains Mono", monospace;
  font-optical-sizing: auto;
  font-weight: 500;
  font-style: normal;
  padding: 10px;
  line-height: 1.4;
  width: 95vw;
  max-width: 900px;
  height: 90vh;
  margin: 0 auto;
  font-size: 1.1rem;
  box-sizing: border-box;
  overflow-y: auto;            
  white-space: pre-wrap;       
}
  </style>
</head>
<body>
<pre id="terminal" tabindex="0"></pre>
  <script>
    // --- Global Game State and Configuration ---
    const term = document.getElementById("terminal");
    let terminalText = ""; // Accumulates the text displayed in the terminal
    let inputBuffer = "";  // Stores the currently typed command
    let cursorOn = true;   // Toggles for the blinking cursor effect
    let gameState = "start"; // Current scene identifier
    let coin = 0;          // Player's currency
    let hp = 100;          // Player's health points
    window.hasBlade = false; // Flag for Demon Blade powerup
    let marketVisits = 0;    // Tracks how many times the player got coins from the market
    let hasGamblersDelight = false; // Flag for luck potion
    let luckBonus = 0;       // Bonus chance from Gambler's Delight
    term.focus();

    /**
     * Blinking cursor interval.
     * Toggles the cursor visibility every 500ms and redraws the terminal.
     */
    setInterval(() => {
        cursorOn = !cursorOn;
        renderTerminal();
    }, 500);

    /**
     * Renders the current state of the terminal to the screen.
     * Combines the history (terminalText), current prompt, and cursor.
     */
    function renderTerminal() {
        term.textContent =
            terminalText +
            "> " + inputBuffer +
            (cursorOn ? "|" : " ");
        // Auto-scroll to the bottom of the terminal
        term.scrollTop = term.scrollHeight;
    }

    /**
     * Global keydown listener to handle user input.
     * Prevents default browser behavior and updates the input buffer.
     */
    window.addEventListener("keydown", (e) => {
        e.preventDefault();
        let key = e.key.toUpperCase(); 

        // Add character keys to the buffer
        if (key.length === 1) inputBuffer += key;
        
        // Handle backspace
        if (key === "BACKSPACE") inputBuffer = inputBuffer.slice(0, -1);

        // Process command on Enter
        if (key === "ENTER") {
            printLine("> " + inputBuffer);
            handleCommand(inputBuffer.trim());
            inputBuffer = "";
        }

        renderTerminal();
    });

    /**
     * Appends a line of text to the terminal history.
     * @param {string} line - The text to print.
     */
    function printLine(line){
        terminalText += line + ("\n");
        renderTerminal();
    }

    /**
     * Displays the text for the current game state.
     */
    function showScene() {
        if (hp <= 0 && gameState !== "dead") {
            gameState = "dead";
        }
        let text = scenes[gameState].text;
        // Evaluate template literals if they are functions or contain dynamic content
        if (typeof text === 'function') {
            let content = text();
            // Basic dynamic replacement for common variables if not using arrow functions
            let processedText = content
                .replace(/\${hp}/g, hp)
                .replace(/\${coin}/g, coin);
            printLine(processedText);
        } else {
            // Basic dynamic replacement for common variables
            let processedText = text
                .replace(/\${hp}/g, hp)
                .replace(/\${coin}/g, coin);
            printLine(processedText);
        }
    }

    /**
     * Game Scenes Data Structure.
     * Each key represents a game state (e.g., 'start', 'crypt').
     * 'text': The story/prompt text for that scene.
     * Other keys (e.g., 'YES', 'NO'): Command handlers for user input.
     * 'restart': If true, any input restarts the game.
     */
    const scenes = {
    start: {
        text: () => `Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.14.0-33-generic x86_64 

72 updates can be applied immediately.
To see these additional updates run: apt list --upgradable

19 additional security updates can be applied with ESM Apps.
Learn more about enabling ESM Apps service at https://ubuntu.com/esm

*** System restart required ***
Last login: Fri Jan  2 00:35:04 2026 from ##########

RUNNING redshift.service


Welcome to THE CRYPT

Current Stats: ${hp} HP | ${coin} COIN

Do you want to ENTER?
(YES/NO)`,
        "YES": () => { 
            printLine("You head down into the gate with the old wooden sign, reading THE CRYPT"); 
            gameState = "crypt"; 
            showScene();
        },
        "NO": () => { printLine("Your loss.");}
            
    },
    crypt: {
        text: () => `You find yourself in a real bad position. A guard just so happened to patrol by here while you were descending into the crypt.
Just your luck, ain't it?

Current Stats: ${hp} HP | ${coin} COIN

Do you FIGHT the guard?
(YES/NO)`,
        "YES": () => { 
            printLine(`You smack the guard across the face and ruin his makeup.
What a progressive crypt, you think to yourself.
He seems pissed tho`); 
            gameState = "fightGuardCrypt"; 
            showScene();
        },
        "NO": () => { printLine(`You back off safely before he notices you.
You look around and find another door, presumably leading deeper into the CRYPT.
You enter the door and dive deeper into the CRYPT.`); 
            gameState = "crypt2";
            showScene();
        },
        "FIGHT": () => {
            scenes.crypt.YES();
        }
            
    },
    fightGuardCrypt: {
        text: () => `The guard seems mad, real mad. You might not make it out alive.
You can try to fight, but who knows if he goes to the gym, he looks pretty strong, well, enough daydreaming.

Current Stats: ${hp} HP | ${coin} COIN

Do you ATTACK the guard or RUN from the guard?
(ATTACK/RUN)`,
        "ATTACK": () => { 
            let outcome = Math.random() < 0.5 ? "slay" : "get_slain";
            if (outcome === "slay") {
                printLine(`You successfully slay the guard, now, where to hide the body?
You dump him in a nearby dumpster and 5 coins fall out of his boxers.
YOU: "Don't mind if I do."
+5 COIN`)
                coin += 5;
                gameState = "crypt2";
            } else {
                printLine("You don't slay the guard. He won. Wow, you are so good at video games, am I right? Go get yourself a medal for BEST GAMER OF THE YEAR!")
                hp = 0;
            }
            showScene();
        },

        "RUN": () => { 
        let outcome = Math.random() < 0.5 ? "escape" : "die";

        if (outcome === "escape") {
            printLine(`You successfully escape from the guard, leaving him panting.
Seems he needs to train cardio. Go Steve!
You find 3 coins scattered on the floor.
`);
            coin += 3;
            gameState = "crypt2"
        } else {
            printLine(`While you are trying to run away, he grabs your arm with such force it untethers from your body, spraying crimson blood all over the crypt floor.
Looks like Steve has to get cleaning duty again. Steve hates that. Best get to work.
`);
            hp = 0;
        }
        showScene();
        },
        "FIGHT": () => {
            scenes.fightGuardCrypt.ATTACK();
        },
        "YES": () => {
            scenes.fightGuardCrypt.ATTACK();
        }
    },
    crypt2: {
        text: () => `
You successfully deal with the guard, being an optimistic adventurer with all their references from pop culture and media where adventuring is all fun and games, well well.
The crypt door seems so alluring, you can't help but go down into the next level of the CRYPT.

Current Stats: ${hp} HP | ${coin} COIN

You find yourself in a deeper underground place, you notice because the air here smells like rotting plants and meat.
Don't ask where the meat is from.

Standing before you is a goblin, holding a sign that says SHOP, pointing to the left. 
To the right, there is a dark, echoing corridor that smells of sulfur.
Talk to the goblin, or go check the dark corridor?
(YES/NO/CAVE)`,
        "YES": () => {
            gameState = "shopCrypt2"
            showScene();
        },
        "DEVEXIT": () => {
          printLine("Cheeky little feller.")
          coin+= 100000000;
          gameState = "crypt2";
          showScene();
        },
        "GOB": () => {
            gameState = "shopCrypt2"
            showScene();
        },
        "CAVE": () => {
            gameState = "enemyCave";
            showScene();
        },
        "NO": () => {
            printLine(`GOB: Your loss. Betcha don't even have any coin do you, little bitch boy?
You descend yet another level down the CRYPT.`);
            gameState = "crypt3corridor";
            showScene();
        }
    
    },
    enemyCave: {
        text: () => `The dark corridor leads into an ENEMY FILLED CAVE. It is damp and filled with the sounds of scurrying creatures. 
You can feel eyes watching you from the shadows. This seems like a good place to find some COIN, if you're willing to risk your life.

Current Stats: ${hp} HP | ${coin} COIN

Do you look for TROUBLE, or go BACK to the main path?
(TROUBLE/BACK)`,
        "TROUBLE": () => {
            let enemyList = [
                { name: "GHOUL", hp: 30, damage: 15 },
                { name: "SKELETON", hp: 25, damage: 10 },
                { name: "ZOMBIE", hp: 40, damage: 8 },
                { name: "SHADOW STALKER", hp: 20, damage: 20 },
                { name: "CAVE BAT", hp: 15, damage: 5 }
            ];
            let enemy = enemyList[Math.floor(Math.random() * enemyList.length)];
            window.currentEnemy = enemy;
            window.enemyHp = enemy.hp;
            printLine(`A wild ${enemy.name} appears! It looks hungry.`);
            gameState = "battle";
            showScene();
        },
        "BACK": () => {
            gameState = "crypt2";
            showScene();
        }
    },
    battle: {
        text: () => `You are facing a ${window.currentEnemy.name}! 
Enemy HP: ${window.enemyHp}
        
Current Stats: ${hp} HP | ${coin} COIN
${window.hasBlade ? "(You are wielding the DEMON BLADE)" : ""}

What do you do?
(ATTACK/DEFEND/RUN)`,
        "ATTACK": () => {
            let hitChance = (window.hasBlade ? 0.8 : 0.6) + luckBonus;
            if (Math.random() < hitChance) {
                let damage = window.hasBlade ? Math.floor(Math.random() * 15) + 10 : Math.floor(Math.random() * 10) + 5;
                window.enemyHp -= damage;
                printLine(`You strike the ${window.currentEnemy.name} for ${damage} damage!`);
            } else {
                printLine(`You swing and miss the ${window.currentEnemy.name}!`);
            }

            if (window.enemyHp <= 0) {
                let reward = Math.floor(Math.random() * 10) + 5;
                coin += reward;
                printLine(`You defeated the ${window.currentEnemy.name}! You found ${reward} COIN inside their guts. Money munchers.`);
                gameState = "enemyCave";
            } else {
                // Enemy counter-attacks
                let enemyHitChance = 0.5 - luckBonus;
                if (Math.random() < enemyHitChance) {
                    let damage = Math.floor(Math.random() * window.currentEnemy.damage) + 5;
                    hp -= damage;
                    printLine(`The ${window.currentEnemy.name} hits you for ${damage} HP!`);
                } else {
                    printLine(`The ${window.currentEnemy.name} lunges at you but misses!`);
                }
            }
            showScene();
        },
        "DEFEND": () => {
            printLine(`You take a defensive stance, watching the ${window.currentEnemy.name}'s movements.`);
            let enemyHitChance = 0.2 - luckBonus;
            if (Math.random() < enemyHitChance) {
                let damage = Math.floor(Math.random() * (window.currentEnemy.damage / 2)) + 2;
                hp -= damage;
                printLine(`Even while defending, the ${window.currentEnemy.name} clips you for ${damage} HP.`);
            } else {
                printLine(`You successfully block the ${window.currentEnemy.name}'s attack!`);
            }
            showScene();
        },
        "RUN": () => {
            let escapeChance = 0.5 + luckBonus;
            if (Math.random() < escapeChance) {
                printLine("You manage to scramble away back to safety.");
                gameState = "enemyCave";
            } else {
                let damage = Math.floor(Math.random() * 10) + 5;
                hp -= damage;
                printLine(`You tried to run, but the ${window.currentEnemy.name} swiped at your back! -${damage} HP.`);
            }
            showScene();
        }
    },
shopCrypt2: {
    text: () => `
You approach the goblin and initiate a conversation.

Current Stats: ${hp} HP | ${coin} COIN

GOB: Hey there, human scum! You want some of that good stuff?
The real good stuff.
We gobs got a shop, very nice, you'll like it.
Come with meeee, please.

(YES/NO)`,
        "YES": () => {
            printLine(`After being led down a sketchy path by the goblin, you see a SHOP overrun by goblins, looks pretty trashed but the items look to be in mint condition.
GOB: Heya lil dude, u got gold?`);
        if(coin > 0){
            printLine(`Nice, little rich one we got here, you seem to have ${coin} coin.`)
            printLine(`Take a look!`)
            gameState = "shopMenu2";
            showScene();
        }   else {
            hp -= 50;
            printLine(`Oh, so you are a lil broke one, huh. We don't like tourists!`)
            printLine(`The goblin punches you in the gut and steals some of your life force instead!
-50 HP. You now have ${hp} HP.`)
            printLine(`After being bullied by the arrogant goblin, you limp back to the main CRYPT room and descend into the next layer.`)
            if (hp > 0) {
                gameState = "crypt3corridor";
            }
            showScene();
        }
      },
        "NO": () => {
            printLine(`
Wow, bet you don't have any coin broke boy, get out of my sight!

After being sent off by the arrogant goblin, you return to the main CRYPT room and descend into the next layer.`);
            gameState = "crypt3corridor";
            showScene();
        }
},
    shopMenu2: {
        text: () => `
The shop is filled with various potions, all of different values and effects

Current Stats: ${hp} HP | ${coin} COIN
        
POTIONS:

HEALTH 20HP - 10 COIN
HEALTH 10HP - 3 COIN
SUICIDE POTION - 999 DAMAGE - 1 COIN
GAMBLERS DELIGHT - All chance elements increase in your favor by 10% - 100 COIN

EXIT - 1 COIN

Don't say we're scamming ya, you entered at your own will and should've read the fine print!
(HEALTH 20HP/HEALTH 10HP/SUICIDE POTION/GAMBLERS DELIGHT/EXIT)`,

        "HEALTH 20HP": () => {
            if (coin >= 10) {
                coin -= 10;
                hp += 20;
                printLine(`Purchased HEALTH 20HP. You now have ${hp} HP and ${coin} COIN.`);
            } else {
                printLine("You don't have enough COIN for that.");
            }
            showScene();
        },
        "HEALTH 10HP": () => {
            if (coin >= 3) {
                coin -= 3;
                hp += 10;
                printLine(`Purchased HEALTH 10HP. You now have ${hp} HP and ${coin} COIN.`);
            } else {
                printLine("You don't have enough COIN for that.");
            }
            showScene();
        },
        "SUICIDE POTION": () => {
            if (coin >= 1) {
                coin -= 1;
                hp -= 999;
                printLine(`You drank the SUICIDE POTION. I bet you listen to My Chemical Romance, you are queer, you have watched and quote charlie the unicorn all the time,
you proably go around saying im transgender but it sounds like you're saying im transginger,  you have blue hair, thats a TV girl reference,
your fave musical is Hamilton even though it should be EPIC, you are questioning your sexuality, your name is Ben, you have a twin sister named Elea,
you should REALLY watch EPIC, you are a bit of a weirdo, dumbass, ao3 reader
and thought it was funny huh? No, actually no. Think of your poor character`);
            } else {
                printLine("You are so broke you can't even afford to end it all. Loser");
            }
            showScene();
        },
        "GAMBLERS DELIGHT": () => {
            if (coin >= 100) {
                coin -= 100;
                hasGamblersDelight = true;
                luckBonus = 0.1;
                printLine("You purchased GAMBLERS DELIGHT. You feel a strange surge of luck flowing through your veins!");
            } else {
                printLine("You need 100 COIN for this. Go slay some enemies.");
            }
            showScene();
        },
        "EXIT": () => {
            if (coin >= 1) {
                coin -= 1;
                printLine(`You paid 1 COIN to exit the shop. ${coin} COIN left.`);
                gameState = "crypt3corridor";
            } else {
                hp -= 50;
                printLine("The goblin blocks the exit. 'Pay the toll, boy! No coin? Then I'll take it in blood!'");
                printLine(`He slashes you as you force your way out. -50 HP. You now have ${hp} HP.`);
                if (hp > 0) {
                    gameState = "crypt3corridor";
                }
            }
            showScene();
        }
    },
    crypt3corridor: {
        text: () => `

After the encounter with the goblin, you continue your descent. The air grows thick and humid, filled with the smell of old silk and damp earth.

Current Stats: ${hp} HP | ${coin} COIN

Suddenly, a SPIDER JUMPS DOWN ON YOUR FACE AND BITES YOUR NOSE!
-3 HP 
(OK)`,
"OK": () => {
    hp -= 3;
    printLine(`Your current HP is ${hp}.`);
    if (hp > 0) {
        gameState = "spiderCityEntrance"; 
    }
    showScene();            
},
"YES": () => {
    scenes.crypt3corridor.OK();
}
    
    
    },

    spiderCityEntrance: {
        text: () => `
After that horrid encounter, you shakingly walk to the next layer of the CRYPT.

Current Stats: ${hp} HP | ${coin} COIN

You find... a city. A spider city. Sthorutweyt, according to a sign written in messy webbing. 
The city of spiders stretches out before you, glowing with eerie bioluminescent fungus.

Do you want to ENTER the city?
(YES/NO)`,
        "YES": () => {
            printLine(`You step through the massive silk-draped gates of Sthorutweyt.`);
            gameState = "spiderPlaza";
            showScene();
        },
        "NO": () => {
            printLine("You decide to skirt the city's edge, but a silk wall blocks your path. You must enter to find the way down.");
            gameState = "spiderPlaza";
            showScene();
        },
    },

    spiderPlaza: {
        text: () => `
You are in the CENTRAL PLAZA of Sthorutweyt. 
Spiders of all sizes scuttle about their business. Some walk on eight legs, others on two, wearing tiny hats.
It's surprisingly organized.

Current Stats: ${hp} HP | ${coin} COIN

Where do you want to go?
- MARKET (Check out the local goods)
- ARENA (Watch or join a fight)
- RESIDENTIAL (Explore the webbed houses)
- GATE (Head deeper into the crypt)

(MARKET/ARENA/RESIDENTIAL/GATE)`,
        "MARKET": () => {
            if (marketVisits >= 1) {
                printLine("The Tarantula merchant recognizes you. 'No more handouts, traveler. Move along.'");
            } else {
                gameState = "spiderMarket";
                showScene();
            }
        },
        "ARENA": () => {
            gameState = "spiderArena";
            showScene();
        },
        "RESIDENTIAL": () => {
            gameState = "spiderResidential";
            showScene();
        },
        "GATE": () => {
            printLine("You head towards the heavy silk-bound gate at the far end of the plaza.");
            gameState = "crypt4";
            showScene();
        }
    },

    spiderMarket: {
        text: () => `
The MARKET is bustling with arachnid merchants. 
One spider is selling "Vintage Flies," another is offering "Silk-woven capes."
A particularly large Tarantula merchant beckons you over.

(TALK/BACK)`,
        "TALK": () => {
            gameState = "spiderConvo";
            showScene();
        },
        "BACK": () => {
            gameState = "spiderPlaza";
            showScene();
        }
    },

    spiderResidential: {
        text: () => `
The RESIDENTIAL district is a maze of hanging cocoons and web-bridges.
It's quiet here, perhaps too quiet. You see a shimmering object caught in a corner web.

Current Stats: ${hp} HP | ${coin} COIN

(SEARCH/BACK)`,
        "SEARCH": () => {
            let outcome = Math.random();
            if (outcome < 0.4) {
                let found = Math.floor(Math.random() * 8) + 2;
                coin += found;
                printLine(`You found ${found} COIN hidden in an old cocoon!`);
            } else if (outcome < 0.7) {
                hp -= 10;
                printLine(`A trap! A tiny mechanical spider bites you. -10 HP.`);
            } else {
                printLine(`You find nothing but sticky webbing and the feeling of being watched.`);
            }
            showScene();
        },
        "BACK": () => {
            gameState = "spiderPlaza";
            showScene();
        }
    },

    spiderConvo: {
        text: () => `The Tarantula merchant looks at you with its many eyes. It seems to be waiting for a response.

Current Stats: ${hp} HP | ${coin} COIN
        
(YES/NO)`,
        "YES": () => {
            printLine(`YOU: "I... I don't understand you, but I come in peace?"
            
The spider tilts its head, then suddenly hands you a small, silk-wrapped package and points toward the plaza.
+10 COIN (found inside the package!)`);
            coin += 10;
            marketVisits++;
            gameState = "spiderPlaza";
            showScene();
        },
        "NO": () => {
            printLine(`You slowly back away from the merchant. It doesn't seem to care and goes back to polishing its silk.`);
            gameState = "spiderPlaza";
            showScene();
        }
    },
    spiderArena: {
        text: () => `The ARENA is a pit of sand. A crowd of spiders cheers from the webbed stands.
${window.currentEnemy ? `Current Opponent: ${window.currentEnemy.name} (HP: ${window.enemyHp})` : "A new challenger awaits."}
        
Current Stats: ${hp} HP | ${coin} COIN
${window.hasBlade ? "(You are wielding the DEMON BLADE)" : ""}

Do you FIGHT for coins, or LEAVE?
(FIGHT/ATTACK/DEFEND/LEAVE)`,
        "FIGHT": () => {
            let opponents = [
                { name: "GIANT SCORPION", hp: 50, damage: 20 },
                { name: "WOLF SPIDER", hp: 40, damage: 15 },
                { name: "BATTLE BEETLE", hp: 60, damage: 12 }
            ];
            window.currentEnemy = opponents[Math.floor(Math.random() * opponents.length)];
            window.enemyHp = window.currentEnemy.hp;
            printLine(`A ${window.currentEnemy.name} enters the arena! The crowd roars!`);
            showScene();
        },
        "ATTACK": () => {
            if (!window.currentEnemy) {
                printLine("You need to enter a FIGHT first!");
                return;
            }
            let hitChance = (window.hasBlade ? 0.8 : 0.6) + luckBonus;
            if (Math.random() < hitChance) {
                let damage = window.hasBlade ? Math.floor(Math.random() * 20) + 10 : Math.floor(Math.random() * 15) + 5;
                window.enemyHp -= damage;
                printLine(`You strike the ${window.currentEnemy.name} for ${damage} damage!`);
            } else {
                printLine(`Your attack misses the swift ${window.currentEnemy.name}!`);
            }

            if (window.enemyHp <= 0) {
                let reward = Math.floor(Math.random() * 20) + 10;
                coin += reward;
                printLine(`Victory! You defeated the ${window.currentEnemy.name}! The crowd throws ${reward} COIN at you.`);
                window.currentEnemy = null;
            } else {
                let enemyHitChance = 0.5 - luckBonus;
                if (Math.random() < enemyHitChance) {
                    let damage = Math.floor(Math.random() * window.currentEnemy.damage) + 5;
                    hp -= damage;
                    printLine(`The ${window.currentEnemy.name} strikes back! -${damage} HP.`);
                } else {
                    printLine(`You dodge the ${window.currentEnemy.name}'s counter-attack!`);
                }
            }
            showScene();
        },
        "DEFEND": () => {
            if (!window.currentEnemy) {
                printLine("You need to enter a FIGHT first!");
                return;
            }
            printLine(`You raise your guard against the ${window.currentEnemy.name}.`);
            let enemyHitChance = 0.2 - luckBonus;
            if (Math.random() < enemyHitChance) {
                let damage = Math.floor(Math.random() * (window.currentEnemy.damage / 2)) + 2;
                hp -= damage;
                printLine(`The ${window.currentEnemy.name} manages to graze you. -${damage} HP.`);
            } else {
                printLine(`Perfect defense! The ${window.currentEnemy.name} can't find an opening.`);
            }
            showScene();
        },
        "LEAVE": () => {
            printLine("You leave the arena and return to the plaza.");
            window.currentEnemy = null;
            gameState = "spiderPlaza";
            showScene();
        }
    },

    crypt4: {
        text: () => `You have reached what seems to be the deepest part of THE CRYPT. 
The air is thick with ancient magic. Before you stands a massive obsidian throne.
Behind the throne, you notice a shimmering portal leading to THE UNDERWORLD.

Current Stats: ${hp} HP | ${coin} COIN

Do you SIT on the throne, or ENTER the portal?
(SIT/PORTAL)`,
        "SIT": () => {
            printLine("As you sit on the throne, you feel a surge of power! You are now the King of the Crypt!");
            printLine("However, the portal behind you begins to pull you in with an irresistible force...");
            gameState = "underworldEntrance";
            showScene();
        },
        "PORTAL": () => {
            printLine("You decide to leave the throne behind and venture into the unknown depths of THE UNDERWORLD.");
            gameState = "underworldEntrance";
            showScene();
        },
        "YES": () => {
            scenes.crypt4.SIT();
        },
        "NO": () => {
            scenes.crypt4.PORTAL();
        }
    },

    underworldEntrance: {
        text: () => `
You have emerged in THE UNDERWORLD. The sky is a bruised purple, and the air smells of ozone and sulfur.
The ground beneath your feet is obsidian, warm to the touch.

Current Stats: ${hp} HP | ${coin} COIN

To your left, a massive LAVA LAKE glows brightly. 
To your right, a dark CATHEDRAL looms over the landscape.
Directly ahead, a PATH leads further into the crimson wastes.

(LAVA/CATHEDRAL/PATH)`,
        "LAVA": () => {
            gameState = "lavaLake";
            showScene();
        },
        "CATHEDRAL": () => {
            gameState = "cathedral";
            showScene();
        },
        "PATH": () => {
            gameState = "underworldPath";
            showScene();
        },
        "LEFT": () => {
            scenes.underworldEntrance.LAVA();
        },
        "RIGHT": () => {
            scenes.underworldEntrance.CATHEDRAL();
        },
        "AHEAD": () => {
            scenes.underworldEntrance.PATH();
        }
    },

    lavaLake: {
        text: () => `
The LAVA LAKE is a spectacle of heat and light. Bubbles of molten rock pop with a low rumble.
You see a small island in the middle with a golden chest.

Current Stats: ${hp} HP | ${coin} COIN

(SWIM/BACK)`,
        "SWIM": () => {
            printLine("You try to swim in lava? Really? You're not a fire elemental.");
            hp -= 100;
            showScene();
        },
        "BACK": () => {
            gameState = "underworldEntrance";
            showScene();
        }
    },

    cathedral: {
        text: () => `
The CATHEDRAL is silent and cold. Tall, stained-glass windows show scenes of ancient battles.
At the altar, a hooded figure stands, seemingly waiting.

Current Stats: ${hp} HP | ${coin} COIN

(TALK/BACK)`,
        "TALK": () => {
            gameState = "demonShop";
            showScene();
        },
        "BACK": () => {
            gameState = "underworldEntrance";
            showScene();
        }
    },

    demonShop: {
        text: () => `
The hooded figure reveals itself to be a DEMON MERCHANT.
DEMON: "Greetings, traveler. Not many make it this far. Want to trade?"

Current Stats: ${hp} HP | ${coin} COIN

ITEMS:
SOUL POTION (+50 HP) - 25 COIN
DEMON BLADE (Logic not implemented) - 50 COIN
BACK - (Return to cathedral)

(SOUL/BLADE/BACK)`,
        "SOUL": () => {
            if (coin >= 25) {
                coin -= 25;
                hp += 50;
                printLine(`Purchased SOUL POTION. You now have ${hp} HP.`);
            } else {
                printLine("DEMON: 'No coin, no soul.'");
            }
            showScene();
        },
        "BLADE": () => {
            if (coin >= 50) {
                coin -= 50;
                window.hasBlade = true;
                printLine("You purchased the DEMON BLADE. You feel much stronger!");
            } else {
                printLine("DEMON: 'Come back when you're richer.'");
            }
            showScene();
        },
        "BACK": () => {
            gameState = "cathedral";
            showScene();
        },
        "POTION": () => {
            scenes.demonShop.SOUL();
        }
    },

    underworldPath: {
        text: () => `
The path stretches endlessly into the crimson distance. 
The journey seems far from over, but your legend is just beginning.

Current Stats: ${hp} HP | ${coin} COIN

(CONTINUE/BACK)`,
        "CONTINUE": () => {
            printLine("You walk for what feels like days. The environment changes, but the adventure continues...");
            // For now, let's loop or add a "to be continued" feel without ending
            gameState = "underworldEntrance";
            showScene();
        },
        "BACK": () => {
            gameState = "underworldEntrance";
            showScene();
        }
    },

    win: {
        text: () => `GAME OVER - YOU WON!
Total Coins: ${coin}
Final HP: ${hp}

Type RESTART or press ENTER to play again.`,
        restart: true,
        "RESTART": () => {}
    },

    dead: {
       text: () => `YOU DIED. Such misfortune.
Total Coins: ${coin}
Final HP: ${hp}

Type RESTART or press ENTER to try again.`,   
    restart: true,
    "RESTART": () => {
        restartGame();
    }
    }
};

/**
 * Resets the game state to initial values.
 */
function restartGame() {
    terminalText = "";
    gameState = "start";
    coin = 0;
    hp = 100;
    window.hasBlade = false;
    marketVisits = 0;
    hasGamblersDelight = false;
    luckBonus = 0;
    window.currentEnemy = null;
    showScene();
}

// --- Game Execution ---

// Basic death check (triggered on load if HP is low)
if (hp <= 0) {
    gameState = "dead";
}

// Initial scene display
showScene();

/**
 * Handles the logic for a user-submitted command.
 * Matches the command against available options in the current scene.
 * @param {string} cmd - The trimmed, uppercase command from the user.
 */
function handleCommand(cmd) {
    const scene = scenes[gameState] || {};

    // Special case: Restarting the game from a 'dead' or final scene
    if (scene.restart) {
        if (cmd === "" || cmd === "RESTART") {
            restartGame();
            return;
        }
    }

    // Ignore empty commands
    if (cmd === "") return; 

    // Find valid command keys in the current scene object (excluding meta-properties)
    const commandKeys = Object.keys(scene).filter(k => k !== "text" && k !== "restart");
    
    // Help system
    if (cmd === "HELP" || cmd === "HINT") {
        printLine("Available commands: " + commandKeys.join(", "));
        return;
    }

    if (commandKeys.length === 0) return;

    // Execute the function associated with the command, if it exists
    if (scene[cmd]) {
        scene[cmd]();
    } else {
        // Fallback for unrecognized commands
        printLine("Unknown command here: " + cmd);
    }
}

  </script>
</body>
</html>